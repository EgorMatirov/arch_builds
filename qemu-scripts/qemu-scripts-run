#!/bin/bash -e

source /etc/qemu-scripts.conf

while getopts "m:h" arg
do
    case "$arg" in
        m) machine="$OPTARG";;
        h) ;;&
        ?) printf "Usage: %s: [-m machine] arguments...\n" "$0" 1>&2 && exit 1;;
    esac
done
shift "$((OPTIND - 1))"

userid="$(whoami)"
iface="tap-$machine"

# exported
root="/srv/kvm/$machine"
argv=("$@")

source "$root/config"

tapctl() { sudo ip tuntap "$@" ; }
add_tap() { tapctl add mode tap "$@" ; }
del_tap() { tapctl del mode tap "$@" ; }

on_exit()
{
    set +e
    local force=""
    if [[ $pid ]]
    then
        echo "terminating $pid" >&2
        if kill -TERM "$pid" &>/dev/null
        then
            wait "$pid"
            force="1"
        fi
    fi
    del_tap dev "$iface"
    if [[ -n $force ]]
    then
        exit 1
    fi
}
trap on_exit TERM INT EXIT

add_tap user "$userid" dev "$iface"

if [[ -z ${qemu[*]} ]]
then
    echo "You have to specify qemu binary!" >&2 && exit 1
fi

if [[ -z $macaddr ]]
then
    macaddr="$(printf 'DE:AD:BE:EF:%02X:%02X\n' $((RANDOM%256)) $((RANDOM%256)))"
fi

set -x
QEMU_BRIDGE="${bridge:?You have to set up bridge interface}" \
    "${qemu[@]}" \
    -net nic,macaddr="$macaddr",model=rtl8139 \
    -net tap,ifname="$iface",script="/usr/lib/qemu-scripts/ifup",downscript=no \
    "${arguments[@]}" &
set +x
pid="$!"

wait "$pid"
